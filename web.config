<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <rewrite>
      <rules>
        <rule name="HTTP to HTTPS" enabled="true" stopProcessing="true">
          <match url="(.*)" ignoreCase="true" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
      </rules>
    </rewrite>

    <httpProtocol>
      <customHeaders>
        <!-- 去重 -->
        <remove name="Content-Security-Policy"/>
        <remove name="X-Frame-Options"/>
        <remove name="X-Content-Type-Options"/>
        <remove name="Referrer-Policy"/>
        <remove name="Strict-Transport-Security"/>

        <!-- CSP（HTTPS 友好：升级+阻断混合内容） -->
        <add name="Content-Security-Policy"
             value="default-src 'self'; img-src 'self' data:; script-src 'self'; style-src 'self'; font-src 'self'; connect-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content" />
        <!-- 点击劫持防护（与 frame-ancestors 并存） -->
        <add name="X-Frame-Options" value="DENY"/>
        <!-- 常见安全头 -->
        <add name="X-Content-Type-Options" value="nosniff"/>
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin"/>
        <!-- HSTS（仅 HTTPS 站点启用；若要上预载，追加 ; preload） -->
        <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains"/>
      </customHeaders>
    </httpProtocol>
  </system.webServer>

  <!-- 兜底：robots.txt 返回与全局一致的安全头；建议实际创建 robots.txt -->
  <location path="robots.txt" inheritInChildApplications="true">
    <system.webServer>
      <httpProtocol>
        <customHeaders>
          <remove name="Content-Security-Policy"/>
          <remove name="X-Frame-Options"/>
          <remove name="X-Content-Type-Options"/>
          <remove name="Referrer-Policy"/>
          <remove name="Strict-Transport-Security"/>

          <add name="Content-Security-Policy"
               value="default-src 'self'; img-src 'self' data:; script-src 'self'; style-src 'self'; font-src 'self'; connect-src 'self'; object-src 'none'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'; upgrade-insecure-requests; block-all-mixed-content" />
          <add name="X-Frame-Options" value="DENY"/>
          <add name="X-Content-Type-Options" value="nosniff"/>
          <add name="Referrer-Policy" value="strict-origin-when-cross-origin"/>
          <add name="Strict-Transport-Security" value="max-age=31536000; includeSubDomains"/>
        </customHeaders>
      </httpProtocol>
    </system.webServer>
  </location>
</configuration>
